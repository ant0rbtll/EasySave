FROM mcr.microsoft.com/dotnet/sdk:8.0.100

WORKDIR /app

# Copier le fichier de solution
COPY EasySave.sln ./
COPY global.json ./

# Copier TOUS les fichiers .csproj de src/
COPY src/EasySave.UI/*.csproj ./src/EasySave.UI/
COPY src/EasySave.Core/*.csproj ./src/EasySave.Core/
COPY src/EasySave.Application/*.csproj ./src/EasySave.Application/
COPY src/EasySave.Backup/*.csproj ./src/EasySave.Backup/
COPY src/EasySave.Persistence/*.csproj ./src/EasySave.Persistence/
COPY src/EasySave.Localization/*.csproj ./src/EasySave.Localization/
COPY src/EasySave.Configuration/*.csproj ./src/EasySave.Configuration/
COPY src/EasySave.System/*.csproj ./src/EasySave.System/
COPY src/EasySave.State/*.csproj ./src/EasySave.State/
COPY src/EasyLog/*.csproj ./src/EasyLog/
COPY src/EasySave.Log/*.csproj ./src/EasySave.Log/

# Copier TOUS les fichiers .csproj de tests/
COPY tests/EasyLog.Tests/*.csproj ./tests/EasyLog.Tests/
COPY tests/EasySave.Log.Tests/*.csproj ./tests/EasySave.Log.Tests/
COPY tests/EasySave.Backup.Tests/*.csproj ./tests/EasySave.Backup.Tests/
COPY tests/EasySave.Application.Tests/*.csproj ./tests/EasySave.Application.Tests/
COPY tests/EasySave.State.Tests/*.csproj ./tests/EasySave.State.Tests/
COPY tests/EasySave.Persistence.Tests/*.csproj ./tests/EasySave.Persistence.Tests/
COPY tests/EasySave.Localization.Tests/*.csproj ./tests/EasySave.Localization.Tests/
COPY tests/EasySave.Configuration.Tests/*.csproj ./tests/EasySave.Configuration.Tests/
COPY tests/EasySave.System.Tests/*.csproj ./tests/EasySave.System.Tests/
COPY tests/EasyLog.Tests/*.csproj ./tests/EasyLog.Tests/

# Restaurer les dépendances
RUN dotnet restore

# Copier le reste du code
COPY . .

# Installer ReportGenerator pour générer les rapports de coverage
RUN dotnet tool install --global dotnet-reportgenerator-globaltool --version 5.5.1
ENV PATH="${PATH}:/root/.dotnet/tools"

# Exécuter tous les tests avec code coverage
CMD dotnet test --collect:"XPlat Code Coverage" --results-directory /app/test-results && \
    reportgenerator \
    -reports:/app/test-results/**/coverage.cobertura.xml \
    -targetdir:/app/coverage-report \
    -reporttypes:Html
