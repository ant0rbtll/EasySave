@startuml
title EasySave 1.0 - Diagramme d'activités : Exécution via ligne de commande

start

:Utilisateur lance EasySave.exe\navec args (ex: "1,3" ou "--all");

if (args[] vide ?) then (Oui)
  :UI.ConsoleUI.MainMenu();
  note right
    Mode interactif
    avec menus
  end note
  stop
else (Non)
  :UI.ConsoleUI.RunFromArgs(args);
endif

:UI.CommandLineParser.Parse(args);
if (Syntaxe valide ?) then (Oui)
  :CommandLineArgs (JobIds[], RunAll);
else (Non)
  :UI.ErrorManager.getMessage("error_parser_arg_invalid");
  :UI.ShowError(LocalizationKey);
  stop
endif

if (RunAll ?) then (Oui)
  :APP.BackupAppService.RunAllJobs();
else (Non)
  :APP.BackupAppService.RunJobsByIds(JobIds);
endif

:Charger les jobs demandés\n(Persistence.IBackupJobRepository.GetById);
if (Au moins 1 job ?) then (Oui)
else (Non)
  :UI.ShowMessage("Aucun travail");
  stop
endif

repeat
  :Sélectionner job suivant;

  :Backup.BackupEngine.Execute(job);

  :ETR.IStateWriter.Update(entry)\nstatus=Active + init totaux;
  :EasyLog.ILogger.Write(entry)\n(eventType CreateDirectory);

  :Lister fichiers + sous-dossiers\n(SystemAbstractions.IFileSystem.EnumerateFilesRecursive);
  if (Fichiers à traiter ?) then (Oui)
    repeat
      :Calculer progrès\n(remaining, percent);
      :ETR.IStateWriter.Update(entry);

      if (BackupType = Differential ?) then (Oui)
        :BackupEngine.CanCopyFile()\ncomparer dates de modification;
        if (Fichier modifié ?) then (Oui)
        else (Non)
          :Passer au fichier suivant;
        endif
      endif

      :SystemAbstractions.ITransferService.TransferFile(src, dst);
      if (Transfert OK ?) then (Oui)
        :EasyLog.ILogger.Write(LogEntry)\nTransferFile (ms, size);
      else (Non)
        :EasyLog.ILogger.Write(LogEntry)\nError;
        :ETR.IStateWriter.Update(entry)\nstatus=Error;
      endif

    repeat while (Fichier suivant ?) is (Oui)
  else (Non)
    :Aucun fichier à traiter;
  endif

  :ETR.IStateWriter.Update(entry)\nstatus=Done;
  :ETR.IStateWriter.MarkInactive(backupId);

repeat while (Job suivant ?) is (Oui)

stop

@enduml