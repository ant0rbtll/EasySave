@startuml
title EasySave - Diagramme de classes (Version actuelle)


' =========================================================
' EasySave - Architecture complète et à jour
' - BackupJob = définition avec ID, Name, Source, Destination, Type
' - BackupAppService = couche application (CreateJob, UpdateJob, RunJob, etc.)
' - BackupEngine = exécution des backups (Complete/Differential)
' - État temps réel = GlobalState avec StateEntry par job
' - Logs = journaliers avec LogEntry (CreateDirectory, TransferFile, Error)
' - Localisation = support multilingue (FR/EN) avec LocalizationKey enum
' - Menus interactifs = MenuFactory, MenuService, MenuConfig
' - Préférences utilisateur = UserPreferences (langue persistée)
' - Limite 5 jobs max (IBackupJobRepository.DefaultMaxJobs)
' =========================================================

' ===================== Core (Domain) =====================
package "Core" {
  enum BackupType {
    Complete
    Differential
  }

  class BackupJob {
    + Id : int
    + Name : string
    + Source : string
    + Destination : string
    + Type : BackupType
  }
  
  BackupJob --> BackupType
}

' ===================== Application =====================
package "Application" as APP {
  class BackupAppService {
    - _repo : IBackupJobRepository
    - _engine : BackupEngine
    --
    + BackupAppService(repo, engine)
    + CreateJob(name, source, destination, type) : void
    + RemoveJob(id) : void
    + UpdateJob(job) : void
    + RunJob(job) : void
    + RunJobById(id) : void
    + RunJobsByIds(ids[]) : void
    + RunAllJobs() : void
    + GetAllJobs() : List<BackupJob>
    + GetJobById(id) : BackupJob?
  }
}

APP.BackupAppService --> Persistence.IBackupJobRepository
APP.BackupAppService --> Backup.BackupEngine

' ===================== UI (Console) =====================
package "UI" {
  class ConsoleUI {
    - _backupAppService : BackupAppService
    - _preferencesRepository : IUserPreferencesRepository
    - _userPreferences : UserPreferences
    - _menuService : MenuService
    - _menuFactory : MenuFactory
    --
    + LocalizationService : ILocalizationService
    --
    + ConsoleUI(backupAppService, preferencesRepository)
    + MainMenu() : void
    + RunFromArgs(parsedArgs) : void
    + ConfigureParams() : void
    + ShowChangeLocale() : void
    + ChangeLocale(locale) : void
    + CreateBackupJob() : void
    + SeeSaveList() : void
    + SaveJob() : void
    + DeleteBackupJob() : void
    + ShowJobsList() : void
    + ShowJobDetails(job) : void
    + RunJob(job) : void
    + UpdateJob(job) : void
    + UpdateJobField(job, field) : void
    + SaveJobUpdate(job) : void
    + DeleteJob(job) : void
    + Quit() : void
    - ShowMessage(key, writeLine) : void
    - ShowError(key) : void
    - AskString(key) : string?
    - AskInt(key) : int?
    - AskBackupType(key) : BackupType?
    - DisplayJobsList() : void
  }

  class MenuService {
    - _localizationService : ILocalizationService
    --
    + MenuService(localizationService)
    + ShowMenu(menuItems : LocalizationKey[], label, renderHeader?) : int
    + ShowMenu(menuItems : string[], label, renderHeader?) : int
    + ShowMenuWithActions(menuItems : LocalizationKey[], actions, label, renderHeader?) : void
    + ShowMenuWithActions(menuItems : string[], actions, label, renderHeader?) : void
    + ShowMenuWithActions(menuConfig) : void
    + DisplayLabel(key) : void
    + WaitForUser(messageKey?) : void
  }

  class MenuConfig {
    + Items : LocalizationKey[]?
    + ItemsAsStrings : string[]?
    + Actions : Dictionary<int, Action>
    + Label : LocalizationKey
    + RenderHeader : Action?
    --
    + MenuConfig(items : LocalizationKey[], actions, label, renderHeader?)
    + MenuConfig(items : string[], actions, label, renderHeader?)
  }

  class MenuFactory {
    - _consoleUI : ConsoleUI
    - _backupAppService : BackupAppService
    --
    + MenuFactory(consoleUI, backupAppService)
    + CreateMainMenu() : MenuConfig
    + CreateLocaleMenu() : MenuConfig
    + CreateParamsMenu() : MenuConfig
    + CreateBackupJobCreationMenu() : MenuConfig
    + CreateJobsListMenu() : MenuConfig
    + CreateJobDetailsMenu(job, renderHeader?) : MenuConfig
    + CreateJobUpdateMenu(job) : MenuConfig
  }

  class Program {
    - {static} initServices() : IServiceProvider
  }

  class CommandLineParser {
    + {static} Parse(args[]) : CommandLineArgs
  }

  class CommandLineArgs {
    + JobIds : int[]
    + RunAll : bool
    + {static} Main(args[]) : void
  }
}

' ===================== Localization =====================
package "Localization" as LOC {
  enum LocalizationKey {
    menu
    menu_create
    menu_list
    menu_job_delete
    config_locale_fr
    config_locale_en
    ...
  }

  interface ILocalizationService {
    + Culture : string
    + AllCultures : Dictionary<string, LocalizationKey>
    --
    + TranslateText(key : string) : string
    + TranslateText(key : LocalizationKey) : string
  }

  class LocalizationService {
    - _translations : Dictionary<string, Dictionary<string, string>>
    - _culture : string
    --
    + LocalizationService(culture)
    + Culture : string
    + AllCultures : Dictionary<string, LocalizationKey>
    + TranslateText(key : string) : string
    + TranslateText(key : LocalizationKey) : string
    - LoadTranslations(culture) : Dictionary<string, string>
  }

  ILocalizationService <|.. LocalizationService
}

' ===================== Persistence =====================
package "Persistence" {
  interface IBackupJobRepository {
    + {static} DefaultMaxJobs : int = 5
    --
    + Add(job) : void
    + Remove(id) : void
    + GetById(id) : BackupJob?
    + GetAll() : List<BackupJob>
    + Count() : int
    + MaxJobs() : int
    + Update(job) : void
  }

  class JsonBackupJobRepository {
    - _pathProvider : IPathProvider
    - _idProvider : IJobIdProvider
    - _jsonOptions : JsonSerializerOptions
    --
    + JsonBackupJobRepository(pathProvider, idProvider)
    + Add(job) : void
    + Remove(id) : void
    + GetById(id) : BackupJob?
    + GetAll() : List<BackupJob>
    + Count() : int
    + MaxJobs() : int
    + Update(job) : void
    - Load() : List<BackupJob>
    - Save(jobs) : void
  }

  class InMemoryBackupJobRepository {
    - _jobs : Dictionary<int, BackupJob>
    - _idProvider : IJobIdProvider
    --
    + InMemoryBackupJobRepository(idProvider)
    + Add(job) : void
    + Remove(id) : void
    + GetById(id) : BackupJob?
    + GetAll() : List<BackupJob>
    + Count() : int
    + MaxJobs() : int
    + Update(job) : void
  }

  interface IJobIdProvider {
    + NextId(existing) : int
  }

  class SequentialJobIdProvider {
    + NextId(existing) : int
  }

  class UserPreferences {
    + Language : string = "fr"
  }

  interface IUserPreferencesRepository {
    + Load() : UserPreferences
    + Save(preferences) : void
  }

  class JsonUserPreferencesRepository {
    - _pathProvider : IPathProvider
    - _jsonOptions : JsonSerializerOptions
    --
    + JsonUserPreferencesRepository(pathProvider)
    + Load() : UserPreferences
    + Save(preferences) : void
    - EnsureDirectoryExists() : void
    - LoadFromFile() : UserPreferences
    - SaveToFile(preferences) : void
  }

  IBackupJobRepository <|.. JsonBackupJobRepository
  IBackupJobRepository <|.. InMemoryBackupJobRepository
  IJobIdProvider <|.. SequentialJobIdProvider
  IUserPreferencesRepository <|.. JsonUserPreferencesRepository
  
  JsonBackupJobRepository --> IJobIdProvider
  InMemoryBackupJobRepository --> IJobIdProvider
}

' ===================== Configuration =====================
package "Configuration" as CFG {
  interface IPathProvider {
    + GetDailyLogPath(date) : string
    + GetStatePath() : string
    + GetJobsConfigPath() : string
    + GetUserPreferencesPath() : string
  }

  class DefaultPathProvider {
    + GetDailyLogPath(date) : string
    + GetStatePath() : string
    + GetJobsConfigPath() : string
    + GetUserPreferencesPath() : string
  }

  IPathProvider <|.. DefaultPathProvider
}

' ===================== Backup (Execution) =====================
package "Backup" {
  class BackupEngine {
    - _fileSystem : IFileSystem
    - _transferService : ITransferService
    - _stateWriter : IStateWriter
    - _logger : ILogger
    --
    + BackupEngine(fileSystem, transferService, stateWriter, logger)
    + Execute(job) : void
    - CanCopyFile(type, source, dest) : bool
    - UpdateState(...) : void
    - Log(eventType, backup, src, dst, size, time) : void
  }
}

' ===================== System =====================
package "SystemAbstractions" {
  interface IFileSystem {
    + DirectoryExists(path) : bool
    + CreateDirectory(path) : void
    + FileExists(path) : bool
    + GetFileSize(path) : long
    + CopyFile(src, dst, overwrite) : void
    + EnsureDirectoryForFileExists(filePath) : void
    + EnumerateFilesRecursive(rootPath) : IEnumerable<string>
    + EnumerateDirectoriesRecursive(rootPath) : IEnumerable<string>
    + Combine(parts...) : string
    + NormalizePath(path) : string
    + GetRelativePath(root, full) : string
  }

  class DefaultFileSystem {
    + DirectoryExists(path) : bool
    + CreateDirectory(path) : void
    + FileExists(path) : bool
    + GetFileSize(path) : long
    + CopyFile(src, dst, overwrite) : void
    + EnsureDirectoryForFileExists(filePath) : void
    + EnumerateFilesRecursive(rootPath) : IEnumerable<string>
    + EnumerateDirectoriesRecursive(rootPath) : IEnumerable<string>
    + Combine(parts...) : string
    + NormalizePath(path) : string
    + GetRelativePath(root, full) : string
  }

  interface ITransferService {
    + TransferFile(source, dest, overwrite) : TransferResult
  }

  class DefaultTransferService {
    - _fileSystem : IFileSystem
    --
    + DefaultTransferService(fileSystem)
    + TransferFile(source, dest, overwrite) : TransferResult
  }

  class TransferResult {
    + Success : bool
    + TransferTimeMs : long
    + FileSizeBytes : long
  }

  IFileSystem <|.. DefaultFileSystem
  ITransferService <|.. DefaultTransferService
  DefaultTransferService --> IFileSystem
  DefaultTransferService ..> TransferResult
}
' ===================== EasyLog (Journalier) =====================
package "EasyLog" {
  enum LogEventType {
    CreateDirectory = 0
    TransferFile = 1
    Error = 2
  }

  class LogEntry <<record>> {
    + Timestamp : DateTime
    + BackupName : string
    + EventType : LogEventType
    + SourcePathUNC : string
    + DestinationPathUNC : string
    + FileSizeBytes : long
    + TransferTimeMs : long
  }

  interface ILogger {
    + Write(entry) : void
  }

  interface ILogFormatter {
    + Format(entry) : string
  }

  class JsonLogFormatter {
    + Format(entry) : string
  }

  class DailyFileLogger {
    - _formatter : ILogFormatter
    - _pathProvider : IPathProvider
    --
    + DailyFileLogger(formatter, pathProvider)
    + Write(entry) : void
    - GetLogPath(date) : string
  }

  ILogger <|.. DailyFileLogger
  ILogFormatter <|.. JsonLogFormatter
  DailyFileLogger --> ILogFormatter
  DailyFileLogger ..> LogEntry
}

' ===================== State (Temps Réel) =====================
package "ETR" {
  enum BackupStatus {
    Inactive
    Active
    Done
    Error
  }

  class StateEntry {
    + BackupId : int
    + BackupName : string?
    + Timestamp : DateTime
    + Status : BackupStatus
    + TotalFiles : int
    + TotalSizeBytes : long
    + RemainingFiles : int
    + RemainingSizeBytes : long
    + ProgressPercent : int
    + CurrentSourcePath : string?
    + CurrentDestinationPath : string?
  }

  class GlobalState {
    + UpdatedAt : DateTime
    + Entries : Dictionary<int, StateEntry>
  }

  interface IStateWriter {
    + Update(entry) : void
    + MarkInactive(backupId) : void
  }

  class RealTimeStateWriter {
    - _pathProvider : IPathProvider
    - _globalState : GlobalState
    --
    + RealTimeStateWriter(pathProvider, globalState)
    + Update(entry) : void
    + MarkInactive(backupId) : void
    - WriteStateFile() : void
  }

  class StateSerializer {
    + {static} Serialize(state) : string
    + {static} Deserialize(json) : GlobalState
  }

  IStateWriter <|.. RealTimeStateWriter
  RealTimeStateWriter --> GlobalState
  RealTimeStateWriter ..> StateSerializer
}

' ===================== Relations cross-package =====================
UI.ConsoleUI --> APP.BackupAppService
UI.ConsoleUI --> Persistence.IUserPreferencesRepository
UI.ConsoleUI --> Persistence.UserPreferences
UI.ConsoleUI --> UI.MenuService
UI.ConsoleUI --> UI.MenuFactory
UI.ConsoleUI --> LOC.ILocalizationService
UI.ConsoleUI --> UI.CommandLineArgs : uses
UI.MenuService --> LOC.ILocalizationService
UI.MenuFactory --> UI.ConsoleUI
UI.MenuFactory --> APP.BackupAppService
UI.MenuFactory ..> UI.MenuConfig

UI.Program ..> UI.ConsoleUI : creates
UI.Program --> UI.CommandLineParser : uses
UI.CommandLineParser ..> UI.CommandLineArgs : creates
UI.Program ..> APP.BackupAppService : creates
UI.Program ..> Persistence.JsonBackupJobRepository : creates
UI.Program ..> Persistence.JsonUserPreferencesRepository : creates
UI.Program ..> Backup.BackupEngine : creates
UI.Program ..> ETR.RealTimeStateWriter : creates
UI.Program ..> EasyLog.DailyFileLogger : creates
UI.Program ..> CFG.DefaultPathProvider : creates

Backup.BackupEngine --> SystemAbstractions.IFileSystem
Backup.BackupEngine --> SystemAbstractions.ITransferService
Backup.BackupEngine --> ETR.IStateWriter
Backup.BackupEngine --> EasyLog.ILogger

Persistence.JsonBackupJobRepository --> CFG.IPathProvider
Persistence.JsonUserPreferencesRepository --> CFG.IPathProvider
EasyLog.DailyFileLogger --> CFG.IPathProvider
ETR.RealTimeStateWriter --> CFG.IPathProvider

@enduml
